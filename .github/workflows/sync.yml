name: ðŸ”„ Daily HS Database Sync v1.4.3

on:
  schedule:
    - cron: '0 4 * * *'  # Codziennie o 4:00 UTC
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Tryb debugowania'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'
  KV_ID: 'd4e909bdc6114613ab76635fadb855b2'

jobs:
  test-api:
    runs-on: ubuntu-latest
    name: ðŸ§ª Test API ISZTAR
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install dependencies
        run: npm install
      
      - name: ðŸŒ Test ISZTAR API connectivity
        run: |
          echo "Testowanie poÅ‚Ä…czenia z API ISZTAR..."
          npm run test-isztar
      
      - name: ðŸ“¡ Test Cloudflare KV
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Testowanie poÅ‚Ä…czenia z Cloudflare KV..."
          echo "KV ID: ${{ env.KV_ID }}"
          
          # Test dostÄ™pnoÅ›ci namespace
          npx wrangler kv namespace list 2>&1 || echo "BÅ‚Ä…d listowania namespace"
          
          # Test odczytu
          npx wrangler kv key get --namespace-id=${{ env.KV_ID }} "HS_METADATA" --remote 2>&1 || echo "Brak metadanych"
          
          echo "âœ… Testy poÅ‚Ä…czeÅ„ zakoÅ„czone"

  sync-database:
    runs-on: ubuntu-latest
    name: ðŸ”„ Synchronizacja bazy danych
    needs: test-api
    if: success()
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install dependencies
        run: |
          npm install
      
      - name: ðŸ› ï¸ Configure Wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ”§ Konfiguracja Wrangler..."
          # SprawdÅº konfiguracjÄ™
          npx wrangler whoami
      
      - name: ðŸ—ƒï¸ Run delta sync
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ”„ Uruchamiam synchronizacjÄ™ delta..."
          echo "Wersja: 1.4.3"
          echo "KV ID: ${{ env.KV_ID }}"
          echo ""
          
          # Uruchom synchronizacjÄ™ z dodatkowym loggingiem
          npm run delta-sync 2>&1 | tee sync.log
          
          # SprawdÅº czy log zawiera bÅ‚Ä™dy
          if grep -q "BÅÄ„D\|ERROR\|âŒ" sync.log; then
            echo "âš ï¸  Wykryto bÅ‚Ä™dy w logach"
            cat sync.log
            exit 1
          fi
      
      - name: ðŸ“Š Verify sync results
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ” Weryfikacja wynikÃ³w synchronizacji..."
          
          # Pobierz metadane
          METADATA=$(npx wrangler kv key get --namespace-id=${{ env.KV_ID }} "HS_METADATA" --remote --json 2>/dev/null || echo "{}")
          
          echo "ðŸ“„ Metadane:"
          echo "$METADATA" | jq . 2>/dev/null || echo "$METADATA"
          
          # SprawdÅº liczbÄ™ rekordÃ³w
          RECORDS=$(echo "$METADATA" | grep -o '"totalRecords":[0-9]*' | cut -d: -f2 || echo "0")
          
          if [ "$RECORDS" -gt 0 ]; then
            echo "âœ… Synchronizacja udana! RekordÃ³w: $RECORDS"
          else
            echo "âš ï¸  Brak rekordÃ³w w bazie"
          fi
      
      - name: ðŸ©º Health check after sync
        run: |
          echo "ðŸ©º Sprawdzanie zdrowia systemu po synchronizacji..."
          
          # OpÃ³Åºnienie, aby Worker mÃ³gÅ‚ siÄ™ zaktualizowaÄ‡
          sleep 10
          
          # SprawdÅº health endpoint
          curl -s "https://hs-code-verifier-api.konto-dla-m-w-q4r.workers.dev/health" | jq . 2>/dev/null || \
          curl -s "https://hs-code-verifier-api.konto-dla-m-w-q4r.workers.dev/health"
          
          echo ""
          echo "ðŸ“Š Statystyki:"
          curl -s "https://hs-code-verifier-api.konto-dla-m-w-q4r.workers.dev/stats" | jq . 2>/dev/null || \
          curl -s "https://hs-code-verifier-api.konto-dla-m-w-q4r.workers.dev/stats"

  manual-fallback:
    runs-on: ubuntu-latest
    name: ðŸ†˜ RÄ™czna synchronizacja (fallback)
    needs: sync-database
    if: failure()
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install dependencies
        run: npm install
      
      - name: ðŸš¨ Execute manual sync fallback
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸš¨ Uruchamiam rÄ™cznÄ… synchronizacjÄ™ fallback..."
          
          # UtwÃ³rz minimalnÄ… bazÄ™ testowÄ…
          TEST_DATA='{"0101":"Konie, osÅ‚y, muÅ‚y Å¼ywe","020110":"Tusze i pÃ³Å‚tusze woÅ‚owe","9999":"Kod testowy"}'
          
          echo "$TEST_DATA" | npx wrangler kv key put --namespace-id=${{ env.KV_ID }} "HS_CURRENT_DATABASE" --remote
          
          # UtwÃ³rz metadane
          META='{"lastSync":"'$(date -Iseconds)'","totalRecords":3,"changes":{"added":3,"updated":0,"removed":0,"unchanged":0},"version":"1.4.3","syncType":"manual_fallback"}'
          
          echo "$META" | npx wrangler kv key put --namespace-id=${{ env.KV_ID }} "HS_METADATA" --remote
          
          echo "âœ… Fallback wykonany - 3 rekordy testowe"