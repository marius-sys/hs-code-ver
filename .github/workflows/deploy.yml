name: ğŸš€ Deploy HS Code Verifier v1.4.1

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'WymuÅ› ponowny deploy'
        required: false
        default: 'false'

env:
  NODE_VERSION: '20'
  WORKER_NAME: 'hs-code-verifier-api'
  WORKER_URL: 'https://hs-code-verifier-api.konto-dla-m-w-q4r.workers.dev'
  KV_ID: 'd4e909bdc6114613ab76635fadb855b2'

jobs:
  setup:
    runs-on: ubuntu-latest
    name: âš™ï¸ Setup and Install
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          npm install
          cd backend
          npm install

  deploy-backend:
    runs-on: ubuntu-latest
    name: âš¡ Deploy Backend Worker
    needs: setup
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend
          npm install

      - name: ğŸš€ Deploy Worker with Environment Variables
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: 'backend'
          # Wrangler automatycznie uÅ¼yje accountId z parametru powyÅ¼ej
          # NIE musimy go wpisywaÄ‡ w wrangler.toml

      - name: ğŸ“ Log deployment info
        run: |
          echo "âœ… Worker zostaÅ‚ wdroÅ¼ony!"
          echo "ğŸŒ URL: ${{ env.WORKER_URL }}"
          echo "ğŸ—„ï¸  KV Namespace ID: ${{ env.KV_ID }}"
          echo "ğŸ‘¤ Account ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          echo ""
          echo "â„¹ï¸  NastÄ™pne kroki:"
          echo "1. Dodaj SYNC_TOKEN i CRON_SECRET w Cloudflare Dashboard"
          echo "2. Uruchom synchronizacjÄ™: npm run delta-sync"
          echo "3. SprawdÅº: curl ${{ env.WORKER_URL }}/health"

  deploy-frontend:
    runs-on: ubuntu-latest
    name: ğŸ¨ Deploy Frontend (GitHub Pages)
    needs: deploy-backend
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Update API URL in frontend
        run: |
          sed -i "s|https://hs-code-verifier-api-production.konto-dla-m-w-q4r.workers.dev|https://hs-code-verifier-api.konto-dla-m-w-q4r.workers.dev|g" frontend/js/app.js

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

  verify-deployment:
    runs-on: ubuntu-latest
    name: âœ… Verify Deployment
    needs: [deploy-backend, deploy-frontend]
    
    steps:
      - name: ğŸ©º Health check
        run: |
          echo "Sprawdzam zdrowie API..."
          sleep 10
          curl -s ${{ env.WORKER_URL }}/health | jq .
          
      - name: ğŸ“Š Deployment summary
        run: |
          echo "ğŸ‰ DEPLOYMENT ZAKOÅƒCZONY!"
          echo ""
          echo "ğŸ“‹ LINKI:"
          echo "â€¢ Frontend: https://marius-sys.github.io/hs-code-ver"
          echo "â€¢ Backend API: ${{ env.WORKER_URL }}"
          echo "â€¢ KV Namespace ID: ${{ env.KV_ID }}"
          echo "â€¢ Cloudflare Account ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          echo ""
          echo "ğŸ”§ NASTÄ˜PNE KROKI:"
          echo "1. Dodaj SYNC_TOKEN i CRON_SECRET w Cloudflare Dashboard"
          echo "2. Uruchom: npm run delta-sync"
          echo "3. Testuj: curl -X POST ${{ env.WORKER_URL }}/verify -H 'Content-Type: application/json' -d '{\"code\":\"0101\"}'"